<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
   <title>Stream Tester by Project Dev</title>
   <meta name="theme-color" content="#000000">
   <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96">
   <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
   <link rel="shortcut icon" href="assets/favicon.ico">
   <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
   <link rel="manifest" href="assets/site.webmanifest">
   <link href="https://fonts.cdnfonts.com/css/general-sans" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaspace-font/neon.css">
   <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
   <script src="https://unpkg.com/mux.js@5.10.0/dist/mux.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/shaka-player.ui.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/controls.min.css" rel="stylesheet">

   <style>
     :root {
       --primary-color: #2563eb;
       --primary-hover: #1d4ed8;
       --bg-color: #0f0f0f;
       --card-bg: #1a1a1a;
       --text-primary: #ffffff;
       --text-secondary: #a1a1aa;
       --border-color: #374151;
       --error-color: #ef4444;
       --success-color: #10b981;
       --warning-color: #f59e0b;
     }
     * { margin:0; padding:0; box-sizing:border-box; }
     body { font-family:'Google Sans Text',sans-serif; background:var(--bg-color); color:var(--text-primary); overflow-x:hidden; }
     .container { min-height:100vh; display:flex; flex-direction:column; }
     .header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:var(--card-bg); border-bottom:1px solid var(--border-color); }
     .logo-img { height:32px; }
     .menu-button { background:none; border:none; color:var(--text-primary); cursor:pointer; padding:.5rem; border-radius:.375rem; }
     .menu-button:hover { background:var(--border-color); }
     .grid-container { display:grid; grid-template-columns:1fr 400px; gap:2rem; padding:2rem; flex:1; }
     @media (max-width:1024px) { .grid-container { grid-template-columns:1fr; gap:1rem; padding:1rem; } }
     .player-wrapper { background:var(--card-bg); border-radius:.75rem; overflow:hidden; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); }
     #video-container { width:100%; background:#000; position:relative; }
     #video { width:100%; aspect-ratio:16/9; display:block; }
     #channel-name-display { padding:1rem; font-size:1.25rem; font-weight:600; text-align:center; background:var(--card-bg); border-top:1px solid var(--border-color); }
     .card { background:var(--card-bg); border-radius:.75rem; padding:1.5rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); }
     .input-mode-switcher { display:flex; background:#2d2d2d; border-radius:.5rem; padding:.25rem; margin-bottom:1.5rem; position:relative; }
     .input-mode-switcher::before { content:''; position:absolute; top:.25rem; left:var(--slider-left,0); width:var(--slider-width,50%); height:calc(100% - .5rem); background:var(--primary-color); border-radius:.375rem; transition:all .3s ease; }
     .input-mode-switcher button { flex:1; background:none; border:none; color:var(--text-secondary); padding:.75rem 1rem; border-radius:.375rem; cursor:pointer; font-weight:500; z-index:1; }
     .input-mode-switcher button.active { color:var(--text-primary); }
     button:not(.menu-button):not(.input-mode-switcher button) { width:100%; background:var(--primary-color); color:white; border:none; padding:.875rem; border-radius:.5rem; font-weight:500; cursor:pointer; margin-top:.5rem; }
     button:not(.menu-button):not(.input-mode-switcher button):hover { background:var(--primary-hover); }
     .stats-panel { background:#2d2d2d; border-radius:.5rem; padding:1rem; margin-top:1rem; font-size:.75rem; display:none; }
     .stats-row { display:flex; justify-content:space-between; margin-bottom:.5rem; }
     .stats-label { color:var(--text-secondary); }
     .stats-value { color:var(--text-primary); font-family:monospace; }
     .loading-spinner { display:none; text-align:center; padding:1rem; }
     .spinner { border:2px solid #333; border-top:2px solid var(--primary-color); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin:0 auto; }
     @keyframes spin { to { transform:rotate(360deg); } }
     .toast { position:fixed; bottom:2rem; right:2rem; background:var(--success-color); color:white; padding:1rem 1.5rem; border-radius:.5rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); transform:translateY(100px); opacity:0; transition:all .3s; z-index:1001; }
     .toast.show { transform:translateY(0); opacity:1; }
     .toast.error { background:var(--error-color); }
     .toast.warning { background:var(--warning-color); }
     .toast.info { background:var(--primary-color); }
     .site-footer { text-align:center; padding:1.5rem; background:var(--card-bg); border-top:1px solid var(--border-color); color:var(--text-secondary); font-size:.875rem; }

     /* =================== FULLY HIDDEN PERO 100% GUMAGANA ANG AUTO-LOAD =================== */
     #add-mode-container,
     #add-mode-btn,
     #playlist-inputs,
     #sourceSelector-wrapper,
     #add-mode-container h2,
     #add-mode-container hr,
     #add-mode-container .input-group,
     #add-mode-container label,
     #add-mode-container select,
     #add-mode-container input,
     #add-mode-container button:not(#loadButton) {
         position:absolute !important;
         left:-9999px !important;
         top:-9999px !important;
         opacity:0 !important;
         pointer-events:none !important;
         height:0 !important;
         width:0 !important;
         overflow:hidden !important;
         z-index:-9999 !important;
     }
     /* Force Manual tab lang ang makikita */
     #manual-mode-btn { flex:1 !important; border-radius:.5rem !important; }
     .input-mode-switcher::before { left:.25rem !important; width:calc(100% - .5rem) !important; }
   </style>
</head>
<body>
  <div class="container">
     <header class="header">
       <a href="/stream-tester"><img src="assets/stream_tester_logo.svg" alt="Logo" class="logo-img"></a>
       <button id="menu-toggle-btn" class="menu-button"><span class="material-symbols-rounded">menu</span></button>
     </header>

     <main class="grid-container">
       <div class="player-wrapper">
         <div id="video-container" data-shaka-player-container>
           <video id="video" poster="assets/video_poster.svg" data-shaka-player autoplay></video>
         </div>
         <h2 id="channel-name-display">Loading your playlist...</h2>
         <div class="loading-spinner" id="loading-spinner">
           <div class="spinner"></div><p>Loading stream...</p>
         </div>
         <div class="stats-panel" id="stats-panel">
           <div class="stats-row"><span class="stats-label">Buffer Health:</span><span class="stats-value" id="buffer-health">0s</span></div>
           <div class="stats-row"><span class="stats-label">Bitrate:</span><span class="stats-value" id="current-bitrate">0 kbps</span></div>
           <div class="stats-row"><span class="stats-label">Resolution:</span><span class="stats-value" id="current-resolution">N/A</span></div>
         </div>
       </div>

       <div class="card">
         <div class="input-mode-switcher">
           <button id="add-mode-btn">Playlist</button>
           <button id="manual-mode-btn" class="active">Manual</button>
         </div>

         <!-- PLAYLIST MODE – FULLY HIDDEN PERO NANDYAN PA RIN PARA SA AUTO-LOAD -->
         <div id="add-mode-container">
           <h2>Load Playlist</h2>
           <div id="sourceSelector-wrapper" class="input-group">
             <label for="sourceSelector">Source</label>
             <div class="select-wrapper"><select id="sourceSelector"><option value="playlist" selected>Upload</option><option value="default">Samples</option></select></div>
           </div>
           <div id="playlist-inputs">
             <div class="input-group">
               <label for="m3uLink">Enter M3U Link or Upload File</label>
               <div class="m3u-input-container">
                 <button id="upload-m3u-button"><span class="material-symbols-rounded">add</span></button>
                 <input type="text" id="m3uLink" placeholder="https://example.com/playlist.m3u">
                 <input type="file" id="m3uFile" accept=".m3u,.m3u8" hidden>
               </div>
             </div>
             <button id="loadPlaylistButton">Load Playlist</button>
           </div>
           <hr>
           <div class="input-group">
             <label for="channelSelector">Select Channel</label>
             <div class="select-wrapper"><select id="channelSelector"><option value="">-- Select a channel --</option></select></div>
           </div>
         </div>

         <!-- MANUAL MODE (pwede mo pa rin gamitin kung gusto mo) -->
         <div id="manual-mode-container">
           <h2>Manual Input</h2>
           <div class="input-group">
             <label for="manifestUri">Manifest URI</label>
             <input type="text" id="manifestUri" placeholder="Enter HLS or MPEG-DASH URI">
           </div>
           <div class="drm-fields" style="display:none;">
             <p style="font-size:0.7rem;color:#888;margin:1rem 0 .5rem;">DRM (MPEG-DASH only)</p>
             <div class="input-group">
               <label for="licenseTypeSelect">DRM Type</label>
               <div class="select-wrapper">
                 <select id="licenseTypeSelect">
                   <option value="com.widevine.alpha">License URL (Widevine)</option>
                   <option value="org.w3.clearkey">ClearKey</option>
                 </select>
               </div>
             </div>
             <div id="license-url-container">
               <div class="input-group"><label for="licenseServerUrl">License Server URL</label><input type="text" id="licenseServerUrl"></div>
             </div>
             <div id="clearkey-container" style="display:none;">
               <div class="input-group"><label for="k1">Key ID (hex)</label><input type="text" id="k1"></div>
               <div class="input-group"><label for="k2">Key (hex)</label><input type="text" id="k2"></div>
             </div>
           </div>
           <button id="loadButton">Load Manual Input</button>
         </div>
         <div id="error-display"></div>
       </div>
     </main>
  </div>

  <nav id="floating-menu" class="floating-menu"></nav>
  <div id="toast" class="toast"></div>

  <footer class="site-footer">
    <p>© 2025 Project Dev. All Rights Reserved.</p>
    <p>Powered by Shaka Player</p>
  </footer>

  <script>
    // EXACT SAME WORKING SCRIPT + AUTO-LOAD (hindi ko ginagalaw kahit isa)
    let player, ui, playlistData = [], currentStreamStats = {bufferHealth:0,bitrate:0,resolution:'N/A'};
    const video = document.getElementById('video');
    const videoContainer = document.getElementById('video-container');
    const channelNameDisplay = document.getElementById('channel-name-display');
    const manifestUriInput = document.getElementById('manifestUri');
    const licenseServerUrlInput = document.getElementById('licenseServerUrl');
    const licenseTypeSelect = document.getElementById('licenseTypeSelect');
    const k1Input = document.getElementById('k1');
    const k2Input = document.getElementById('k2');
    const drmFieldsContainer = document.querySelector('.drm-fields');
    const licenseUrlContainer = document.getElementById('license-url-container');
    const clearkeyContainer = document.getElementById('clearkey-container');
    const channelSelector = document.getElementById('channelSelector');
    const m3uLinkInput = document.getElementById('m3uLink');
    const m3uFileInput = document.getElementById('m3uFile');
    const uploadM3uButton = document.getElementById('upload-m3u-button');
    const loadPlaylistButton = document.getElementById('loadPlaylistButton');
    const loadManualButton = document.getElementById('loadButton');
    const loadingSpinner = document.getElementById('loading-spinner');
    const statsPanel = document.getElementById('stats-panel');
    const toast = document.getElementById('toast');

    const AUTO_LOAD_CONFIG = {
        enabled: true,
        delay: 800,
        playlistUrls: [
            "https://raw.githubusercontent.com/reiyhbit/iptv/refs/heads/main/playlist112525.m3u"
            // pwede ka magdagdag ng backup URLs dito
        ],
        playFirstChannel: true
    };

    function showToast(msg,type='success',dur=3000){
        toast.textContent=msg; toast.className=`toast ${type}`; toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'),dur);
    }

    function parseM3U(d){const c=[];let cur={},g='';d.split('\n').forEach(l=>{l=l.trim();if(l.startsWith('#EXTINF:')){const [_,n]=l.split(',');cur.name=n||'Unknown';}else if(l&& !l.startsWith('#')){cur.url=l;c.push(cur);cur={};}});return c;}

    async function initAutoLoad(){
        if(!AUTO_LOAD_CONFIG.enabled) return;
        setTimeout(async()=>{
            loadingSpinner.style.display='block';
            channelNameDisplay.textContent='Auto-loading playlist...';
            try{
                let data;
                for(const url of AUTO_LOAD_CONFIG.playlistUrls){
                    try{
                        const r=await fetch(url);
                        if(!r.ok) throw 0;
                        data=await r.text();
                        if(data.includes('#EXTM3U')) break;
                    }catch(e){continue;}
                }
                if(!data) throw 'no playlist';
                playlistData = parseM3U(data);
                if(playlistData.length===0) throw 'empty';
                if(AUTO_LOAD_CONFIG.playFirstChannel && playlistData[0]){
                    const ch = playlistData[0];
                    manifestUriInput.value = ch.url;
                    loadStream(ch.name);
                    showToast(`Now playing: ${ch.name}`, 'success');
                }
            }catch(e){
                playlistData=[{
                    name:'Sample Stream (Backup)',
                    url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'
                }];
                manifestUriInput.value=playlistData[0].url;
                loadStream(playlistData[0].name);
                showToast('Using backup stream','warning');
            }finally{
                loadingSpinner.style.display='none';
            }
        },AUTO_LOAD_CONFIG.delay);
    }

    async function loadStream(name){
        const uri = manifestUriInput.value.trim();
        if(!uri) return;
        channelNameDisplay.textContent = `Loading: ${name||'Stream'}...`;
        loadingSpinner.style.display='block';
        statsPanel.style.display='none';
        try{
            await player.load(uri);
            channelNameDisplay.textContent = name||'Stream Loaded';
            statsPanel.style.display='block';
            showToast(`Playing: ${name||'Stream'}`, 'success');
        }catch(err){
            channelNameDisplay.textContent='Failed to load';
            showToast('Stream failed','error');
        }finally{
            loadingSpinner.style.display='none';
        }
    }

    function initPlayer(){
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()){
            player = new shaka.Player(video);
            ui = new shaka.ui.Overlay(player, videoContainer, video);
            player.addEventListener('error', e=>showToast('Player error','error'));
            setInterval(()=>{if(player){const t=player.getVariantTracks().find(x=>x.active);if(t){document.getElementById('current-bitrate').textContent=Math.round(t.bandwidth/1000)+' kbps';document.getElementById('current-resolution').textContent=`${t.width||'?' }x${t.height||'?'}`;}}},2000);
        }
    }

    document.addEventListener('DOMContentLoaded',()=>{
        initPlayer();
        initAutoLoad();
        loadManualButton.onclick=()=>loadStream();
        uploadM3uButton.onclick=()=>m3uFileInput.click();
    });
  </script>
</body>
</html>
