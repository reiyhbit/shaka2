<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
   <title>ReiTV Pro • AutoPlay + Full DRM</title>
   <meta name="theme-color" content="#000000">
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap">
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
   
   <!-- Shaka Player Latest (pinakastable + full DRM support) -->
   <script src="https://unpkg.com/mux.js@latest/dist/mux.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.min.css" rel="stylesheet">

   <style>
     :root{--primary:#00d4ff;--bg:#0f0f0f;--card:#1a1a1a;--text:#fff;--muted:#a1a1aa;--border:#374151;--error:#ef4444;--success:#10b981}
     *{margin:0;padding:0;box-sizing:border-box}
     body{font-family:'Google Sans Text',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;height:100vh;display:flex;flex-direction:column}
     header{padding:1rem 2rem;background:var(--card);border-bottom:1px solid var(--border);text-align:center}
     .logo{font-size:1.8rem;font-weight:700;background:linear-gradient(90deg,#00d4ff,#00ff9d);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
     .grid-container{display:grid;grid-template-columns:1fr 420px;gap:2rem;padding:2rem;flex:1;overflow:hidden}
     @media(max-width:1024px){.grid-container{grid-template-columns:1fr;padding:1rem}}
     #video-container{background:#000;position:relative;border-radius:0.75rem;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
     #video{width:100%;height:100%;object-fit:contain}
     #channel-name-display{padding:1rem;font-size:1.3rem;font-weight:600;text-align:center;background:var(--card);border-top:1px solid var(--border)}
     .card{background:var(--card);border-radius:0.75rem;padding:1.5rem;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
     .loading-spinner{position:absolute;inset:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;z-index:10}
     .spinner{border:4px solid #333;border-top:4px solid var(--primary);border-radius:50%;width:50px;height:50px;animation:s 1s linear infinite}
     @keyframes s{to{transform:rotate(360deg)}}
     .toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:0.5rem;background:var(--success);color:#fff;z-index:1001;opacity:0;transform:translateY(100px);transition:all .3s}
     .toast.show{opacity:1;transform:translateY(0)}
     .toast.error{background:var(--error)}
     .stats-panel,.channel-info{background:#2d2d2d;border-radius:0.5rem;padding:1rem;margin-top:1rem;font-size:0.85rem}
     .info-row,.stats-row{display:flex;justify-content:space-between;margin:0.5rem 0}
     footer{padding:1.5rem;background:var(--card);border-top:1px solid var(--border);text-align:center;color:var(--muted);font-size:0.9rem}
   </style>
</head>
<body>

<div class="container">
  <header><div class="logo">ReiTV Pro • AutoPlay</div></header>

  <main class="grid-container">
    <div class="player-wrapper">
      <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="loading-spinner" id="loading">
          <div class="spinner"></div>
          <p>Auto-loading your playlist...<br><small>Finding first working channel...</small></p>
        </div>
      </div>
      <h2 id="channel-name-display">Initializing AutoPlay...</h2>
      <div class="stats-panel" id="stats-panel" style="display:none">
        <div class="stats-row"><span>Buffer:</span><span id="buffer-health">0s</span></div>
        <div class="stats-row"><span>Bitrate:</span><span id="current-bitrate">0 kbps</span></div>
        <div class="stats-row"><span>Resolution:</span><span id="current-resolution">N/A</span></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:1rem;color:var(--primary)">Auto-loaded Playlist</h3>
      <p style="margin-bottom:1rem;font-size:0.9rem;color:var(--muted)">
        <strong>reiyhbit.github.io/iptv/playlist112525.m3u</strong><br>
        <span id="channel-count">Loading channels...</span>
      </p>
      <button onclick="playNext()" style="background:var(--primary);margin-bottom:1rem">Next Working Channel</button>
      <button onclick="location.reload()" style="background:#666">Reload Playlist</button>
      
      <div class="channel-info">
        <div class="info-row"><span>Current:</span><span id="info-name">—</span></div>
        <div class="info-row"><span>Status:</span><span id="info-status">Testing...</span></div>
      </div>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>
<footer>© 2025 ReiTV Pro • Full DRM Support • AutoPlay Engine v2</footer>

<script>
  const video = document.getElementById('video');
  const container = document.getElementById('video-container');
  const channelNameDisplay = document.getElementById('channel-name-display');
  const loading = document.getElementById('loading');
  const toast = document.getElementById('toast');
  const infoName = document.getElementById('info-name');
  const infoStatus = document.getElementById('info-status');
  const channelCount = document.getElementById('channel-count');

  let player, channels = [], currentIdx = 0;

  const PLAYLIST_URL = "https://reiyhbit.github.io/iptv/playlist112525.m3u";

  function showToast(msg, type = 'success') {
    toast.textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.className = 'toast', 4000);
  }

  function initPlayer() {
    shaka.polyfill.installAll();
    player = new shaka.Player(video);
    new shaka.ui.Overlay(player, container, video);
    player.addEventListener('error', () => {
      infoStatus.textContent = "Failed → skipping...";
      setTimeout(playNext, 3000);
    });
  }

  async function loadPlaylist() {
    try {
      const res = await fetch(PLAYLIST_URL + "?t=" + Date.now());
      const text = await res.text();
      channels = parseM3U(text);
      channelCount.textContent = `${channels.length} channels loaded • Testing live ones...`;
      playFirstWorking();
    } catch {
      channelNameDisplay.textContent = "Playlist unreachable";
    }
  }

  function parseM3U(t) {
    const lines = t.split('\n');
    const res = [];
    let ch = {};
    for (let l of lines) {
      l = l.trim();
      if (l.startsWith('#EXTINF:')) {
        const name = l.split(',').pop().trim();
        const logo = l.match(/tvg-logo="([^"]+)"/)?.[1] || '';
        const group = l.match(/group-title="([^"]+)"/)?.[1] || '';
        ch = {name, logo, group};
      } else if (l && !l.startsWith('#')) {
        ch.url = l;
        if (ch.name) res.push(ch);
        ch = {};
      }
    }
    return res.sort((a,b) => a.name.localeCompare(b.name));
  }

  async function testStream(url) {
    try {
      await fetch(url, {method:'HEAD', mode:'no-cors'});
      return true;
    } catch {
      try {
        const r = await fetch(url, {signal: AbortSignal.timeout(9000)});
        return r.ok;
      } catch { return false; }
    }
  }

  async function playFirstWorking() {
    for (let i = 0; i < channels.length; i++) {
      channelNameDisplay.textContent = `Testing: ${channels[i].name}`;
      if (await testStream(channels[i].url)) {
        currentIdx = i;
        playChannel(i);
        return;
      }
    }
    channelNameDisplay.textContent = "No working channels found";
    loading.style.display = "none";
  }

  async function playChannel(i) {
    const ch = channels[i];
    currentIdx = i;
    channelNameDisplay.textContent = ch.name;
    infoName.textContent = ch.name;
    infoStatus.textContent = "Loading...";
    loading.style.display = "flex";

    try {
      await player.load(ch.url);
      loading.style.display = "none";
      infoStatus.textContent = "LIVE";
      showToast(`Now playing: ${ch.name}`);
      document.getElementById('stats-panel').style.display = 'block';
    } catch {
      infoStatus.textContent = "Failed → next";
      setTimeout(playNext, 3000);
    }
  }

  function playNext() {
    let next = (currentIdx + 1) % channels.length;
    playChannel(next);
  }

  // Auto start
  initPlayer();
  loadPlaylist();

  // Optional: stats update every second
  setInterval(() => {
    if (player) {
      const tracks = player.getVariantTracks().filter(t => t.active);
      if (tracks[0]) {
        document.getElementById('current-bitrate').textContent = Math.round(tracks[0].bandwidth/1000) + " kbps";
        document.getElementById('current-resolution').textContent = `${tracks[0].width||'?' }x${tracks[0].height||'?'}`;
        document.getElementById('buffer-health').textContent = player.getBufferHealth().toFixed(1) + "s";
      }
    }
  }, 1000);
</script>
</body>
</html>
