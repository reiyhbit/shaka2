<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ReiTV Player</title>
  <meta name="theme-color" content="#0a0a0a" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>TV</text></svg>">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- Shaka Player (Latest) -->
  <script src="https://unpkg.com/mux.js@latest/dist/mux.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.min.css">

  <style>
    :root{--bg:#0a0a0a;--card:#111;--accent:#00ffd5;--text:#fff;--muted:#aaa;--border:#222;--hover:#1a1a1a}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
    header{background:rgba(17,17,17,0.95);backdrop-filter:blur(12px);padding:1rem;text-align:center;border-bottom:1px solid var(--border);position:relative;z-index:10}
    .logo{font-size:1.8rem;font-weight:800;background:linear-gradient(90deg,#00ffd5,#00b7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    main{flex:1;display:grid;grid-template-columns:1fr 400px;gap:0;overflow:hidden}
    @media(max-width:992px){main{grid-template-columns:1fr}.sidebar{display:none}.toggle-btn{display:flex!important}}
    #video-container{position:relative;background:#000}
    #video{width:100%;height:100%;object-fit:contain}
    .channel-name{position:absolute;bottom:24px;left:24px;background:rgba(0,0,0,0.75);padding:10px 18px;border-radius:12px;font-weight:600;backdrop-filter:blur(10px);font-size:1.1rem;z-index:5}
    .loading{position:absolute;inset:0;background:rgba(0,0,0,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;gap:1.5rem;font-size:1.2rem}
    .spinner{width:60px;height:60px;border:5px solid #222;border-top:5px solid var(--accent);border-radius:50%;animation:s 1s linear infinite}
    @keyframes s{to{transform:rotate(360deg)}}
    .sidebar{background:var(--card);border-left:1px solid var(--border);overflow-y:auto;padding:1.2rem;display:flex;flex-direction:column;gap:1rem}
    .search{width:100%;padding:14px 18px;background:var(--hover);border:1px solid var(--border);border-radius:14px;color:white;font-size:1rem}
    .channel-list{list-style:none;flex:1;overflow-y:auto}
    .channel-item{padding:14px 16px;border-radius:12px;margin-bottom:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:14px}
    .channel-item:hover{background:var(--hover)}
    .channel-item.active{background:var(--accent);color:#000;font-weight:600}
    .channel-logo{width:40px;height:40px;border-radius:10px;object-fit:contain;background:#222;flex-shrink:0}
    .channel-title{flex:1;font-size:0.98rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .toggle-btn{display:none;position:absolute;top:80px;right:16px;background:rgba(0,0,0,0.7);color:white;border:none;padding:14px;border-radius:50%;z-index:10;backdrop-filter:blur(10px)}
    .status{font-size:0.85rem;color:var(--muted);text-align:center;padding:0.5rem 0}
    .footer{text-align:center;padding:0.8rem;font-size:0.8rem;color:var(--muted);background:var(--card);border-top:1px solid var(--border)}
  </style>
</head>
<body>

  <header>
    <div class="logo">ReiTV Player</div>
  </header>

  <button class="toggle-btn" onclick="document.querySelector('.sidebar').style.display='block'">
    <span class="material-symbols-rounded">list</span>
  </button>

  <main>
    <div id="video-container">
      <video id="video" playsinline autoplay muted></video>
      <div class="channel-name" id="current">Loading channels...</div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Fetching your playlist...</div>
      </div>
    </div>

    <aside class="sidebar">
      <input type="text" class="search" placeholder="Search channels..." id="search">
      <div class="status" id="status">Loading 0 channels...</div>
      <ul class="channel-list" id="list"></ul>
    </aside>
  </main>

  <div class="footer">© 2025 ReiTV • Auto-loaded from your playlist</div>

  <script>
    const video = document.getElementById('video');
    const container = document.getElementById('video-container');
    const currentEl = document.getElementById('current');
    const loading = document.getElementById('loading');
    const list = document.getElementById('list');
    const status = document.getElementById('status');
    const search = document.getElementById('search');

    let player, channels = [];

    // DIRECT EMBEDDED PLAYLIST MO (no upload needed!)
    const PLAYLIST_URL = "https://reiyhbit.github.io/iptv/playlist112525.m3u";

    function initPlayer() {
      shaka.polyfill.installAll();
      player = new shaka.Player(video);
      new shaka.ui.Overlay(player, container, video);
      player.addEventListener('error', () => {
        currentEl.textContent = "Stream failed → skipping...";
        setTimeout(nextChannel, 2500);
      });
    }

    async function loadPlaylist() {
      try {
        const res = await fetch(PLAYLIST_URL + "?t=" + Date.now());
        const text = await res.text();
        channels = parseM3U(text);
        channels.sort((a,b) => a.name.localeCompare(b.name));
        renderChannels(channels);
        status.textContent = `${channels.length} channels loaded • Playing first working...`;
        playFirstWorking();
      } catch {
        currentEl.textContent = "Failed to load playlist";
      }
    }

    function parseM3U(text) {
      const lines = text.split('\n');
      const result = [];
      let ch = {};
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('#EXTINF:')) {
          const name = line.split(',').pop().trim();
          const logo = line.match(/tvg-logo="([^"]+)"/)?.[1] || '';
          ch = { name, logo };
        } else if (line && !line.startsWith('#')) {
          ch.url = line;
          if (ch.name && ch.url) result.push(ch);
          ch = {};
        }
      }
      return result;
    }

    function renderChannels(arr) {
      list.innerHTML = "";
      arr.forEach((ch, i) => {
        const li = document.createElement('li');
        li.className = "channel-item";
        li.innerHTML = `
          <img src="${ch.logo || 'https://via.placeholder.com/40/222/fff?text=TV'}" class="channel-logo" onerror="this.src='https://via.placeholder.com/40/222/fff?text=TV'">
          <div class="channel-title">${ch.name}</div>
        `;
        li.onclick = () => play(i, arr);
        list.appendChild(li);
      });
    }

    async function playFirstWorking() {
      loading.style.display = "flex";
      for (let i = 0; i < channels.length; i++) {
        if (await testStream(channels[i].url)) {
          play(i);
          return;
        }
      }
      currentEl.textContent = "No working channels found";
      loading.style.display = "none";
    }

    async function testStream(url) {
      try {
        const r = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
        return true;
      } catch {
        try {
          const r = await fetch(url.split('|')[0], { signal: AbortSignal.timeout(8000) });
          return r.ok;
        } catch { return false; }
      }
    }

    async function play(idx, source = channels) {
      const ch = source[idx];
      document.querySelectorAll('.channel-item').forEach((el, i) => el.classList.toggle('active', i === idx));
      currentEl.textContent = ch.name;
      loading.style.display = "flex";
      try {
        await player.load(ch.url);
        loading.style.display = "none";
      } catch {
        loading.style.display = "none";
        currentEl.textContent = "Failed → next...";
        nextChannel();
      }
    }

    function nextChannel() {
      let idx = channels.findIndex(c => c.name === currentEl.textContent);
      idx = (idx + 1) % channels.length;
      setTimeout(() => play(idx), 2000);
    }

    search.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = channels.filter(c => c.name.toLowerCase().includes(term));
      renderChannels(filtered);
    });

    window.onload = () => {
      initPlayer();
      loadPlaylist();
    };
  </script>
</body>
</html>
