<!doctype html>
<html lang="en">
<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="no-referrer" name="referrer">
    <link href="data:image/x-icon;," rel="icon">
    <title>ReynielTV - Clean IPTV</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.2/controls.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Arial,sans-serif;background:#1a1a1a;color:white;height:100vh;overflow:hidden}
        #app-container{display:flex;flex-direction:column;height:100vh}
        #video-container{height:40vh;background:#000;position:relative;flex-shrink:0}
        #video{width:100%;height:100%;object-fit:contain}
        #brand-logo{position:absolute;top:10px;left:10px;z-index:10;display:flex;align-items:center}
        #brand-circle{width:40px;height:40px;background:#ff0000;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;text-align:center;line-height:1.1;box-shadow:0 0 10px rgba(255,0,0,0.7)}
        #maximize-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center}
        #maximize-btn:active{background:rgba(97,218,251,0.8)}
        #controls-container{flex:1;background:#2d2d2d;display:flex;flex-direction:column;overflow:hidden}
        #channel-info{padding:8px 15px;background:#3c4043;border-bottom:1px solid #444;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        #current-channel{font-size:16px;font-weight:bold;margin-bottom:2px}
        #channel-status{font-size:12px;color:#61dafb}
        .favorite-btn{background:none;border:none;color:#888;font-size:18px;cursor:pointer;padding:5px}
        .favorite-btn.active{color:#ff6b35}
        #nav-buttons{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:8px;flex-shrink:0}
        .nav-btn{padding:10px;background:#61dafb;color:#000;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer}
        .nav-btn:active{background:#4fa3c4;transform:scale(0.95)}
        #category-tabs{display:flex;padding:0 10px;border-bottom:1px solid #444;flex-shrink:0;overflow-x:auto}
        .category-tab{padding:8px 12px;background:none;border:none;color:#aaa;font-size:13px;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent}
        .category-tab.active{color:#61dafb;border-bottom-color:#61dafb}
        #quick-channels{flex:1;overflow-y:auto;padding:5px;display:grid;grid-template-columns:1fr 1fr;gap:5px}
        .quick-channel{display:flex;align-items:center;padding:5px 6px;background:#3c4043;border-radius:5px;cursor:pointer;min-height:32px;position:relative}
        .quick-channel:active{background:#61dafb;color:#000}
        .quick-channel.active{background:#4fa3c4}
        .channel-logo{width:22px;height:22px;margin-right:6px;border-radius:3px;object-fit:cover;flex-shrink:0}
        .channel-name{font-size:11px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .channel-fav{color:#ff6b35;font-size:11px;margin-left:4px}
        #channel-list-btn{margin:6px;padding:10px;background:#61dafb;color:#000;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;flex:1}
        .bottom-actions{display:flex;gap:8px;padding:6px;flex-shrink:0}
        #settings-btn{padding:10px;background:#555;color:white;border:none;border-radius:6px;cursor:pointer;width:50px;display:flex;align-items:center;justify-content:center}
        .fullscreen #video-container{height:100vh;position:fixed;top:0;left:0;width:100%;z-index:1000}
        .fullscreen #controls-container{display:none}
        .fullscreen #maximize-btn{top:20px;right:20px;background:rgba(0,0,0,0.8)}
        #channel-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1001;display:none;flex-direction:column}
        #channel-header{padding:15px;background:#2d2d2d;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #444}
        #close-channels{background:#ff4444;color:white;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:14px}
        #channels-list{flex:1;overflow-y:auto;padding:10px}
        .channel-item{display:flex;align-items:center;padding:8px;margin-bottom:5px;background:#3c4043;border-radius:6px;cursor:pointer}
        .channel-item:active{background:#61dafb;color:#000}
        .channel-item.active{background:#4fa3c4}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 20px;border-radius:8px;z-index:2000;animation:fadeInOut 3s ease-in-out}
        @keyframes fadeInOut{0%,100%{opacity:0}10%,90%{opacity:1}}
        .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#61dafb;font-size:16px}
        #channel-search{width:100%;padding:10px;margin:10px;background:#1a1a1a;border:1px solid #444;border-radius:8px;color:white;font-size:14px}
        #settings-panel{position:fixed;top:0;right:-300px;width:300px;height:100%;background:#2d2d2d;z-index:1002;transition:right .3s ease;padding:20px;overflow-y:auto}
        #settings-panel.open{right:0}
        .settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid #444}
        .settings-option{margin-bottom:15px}
        .settings-label{display:block;margin-bottom:5px;font-size:14px}
        .settings-select{width:100%;padding:8px;background:#1a1a1a;border:1px solid #444;border-radius:5px;color:white}
        #recent-channels{display:none;padding:8px;border-bottom:1px solid #444;overflow-x:auto;white-space:nowrap}
        .recent-channel{display:inline-flex;align-items:center;padding:4px 8px;margin-right:6px;background:#3c4043;border-radius:12px;font-size:11px;cursor:pointer}
        #volume-control{position:absolute;bottom:20px;right:20px;background:rgba(0,0,0,0.7);padding:10px;border-radius:20px;display:none;flex-direction:column;align-items:center;z-index:20}
        #volume-slider{width:100px;height:5px;-webkit-appearance:none;background:#555;border-radius:5px;margin:10px 0;outline:none}
        #volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:15px;height:15px;border-radius:50%;background:#61dafb;cursor:pointer}
    </style>
</head>
<body>
    <div id="app-container">
        <div id="video-container">
            <div id="brand-logo">
                <div id="brand-circle">Reyniel<br>TV</div>
            </div>
            <video id="video" controls playsinline></video>
            <button id="maximize-btn">Full Screen</button>
            <div class="loading" id="loading" style="display:none">Loading...</div>
            <div id="volume-control">
                <i class="fas fa-volume-up"></i>
                <input type="range" id="volume-slider" min="0" max="100" value="100">
            </div>
        </div>

        <div id="controls-container">
            <div id="channel-info">
                <div>
                    <div id="current-channel">Select a channel</div>
                    <div id="channel-status">Ready</div>
                </div>
                <button class="favorite-btn" id="favorite-btn"><i class="far fa-star"></i></button>
            </div>

            <div id="recent-channels"></div>

            <div id="category-tabs">
                <button class="category-tab active" data-category="all">All Channels</button>
                <button class="category-tab" data-category="favorites">Favorites</button>
            </div>

            <div id="nav-buttons">
                <button class="nav-btn" id="prev-channel">PREV</button>
                <button class="nav-btn" id="next-channel">NEXT</button>
            </div>

            <div id="quick-channels"></div>

            <div class="bottom-actions">
                <button id="channel-list-btn">ALL CHANNELS</button>
                <button id="settings-btn"><i class="fas fa-cog"></i></button>
            </div>
        </div>
    </div>

    <!-- Full Channel List Overlay -->
    <div id="channel-overlay">
        <div id="channel-header">
            <h3>All Channels</h3>
            <button id="close-channels">Close</button>
        </div>
        <input type="text" id="channel-search" placeholder="Search channels...">
        <div id="channels-list"></div>
    </div>

    <!-- Settings Panel with DRM -->
    <div id="settings-panel">
        <div class="settings-header">
            <h3>Settings</h3>
            <button id="close-settings"><i class="fas fa-times"></i></button>
        </div>

        <div class="settings-option">
            <label class="settings-label">Video Quality</label>
            <select class="settings-select" id="quality-select">
                <option value="auto">Auto</option>
                <option value="hd">HD</option>
                <option value="sd">SD</option>
                <option value="low">Low</option>
            </select>
        </div>

        <div class="settings-option">
            <label class="settings-label">DRM Type</label>
            <select class="settings-select" id="licenseTypeSelect">
                <option value="com.widevine.alpha">Widevine License URL</option>
                <option value="org.w3.clearkey">ClearKey (KeyID + Key)</option>
            </select>
        </div>

        <div class="settings-option" id="widevineUrlOption">
            <label class="settings-label">Widevine License URL</label>
            <input type="text" class="settings-select" id="widevineLicenseUrl" placeholder="https://license.example.com/widevine">
        </div>

        <div class="settings-option" id="clearkeyOption" style="display:none;">
            <label class="settings-label">ClearKey KeyID (32 hex)</label>
            <input type="text" class="settings-select" id="clearkeyId" placeholder="e.g. 3a3149..." maxlength="32">
            <label class="settings-label" style="margin-top:10px">ClearKey Key (32 hex)</label>
            <input type="text" class="settings-select" id="clearkeyKey" placeholder="e.g. 8f2d1a..." maxlength="32">
        </div>

        <div class="settings-option">
            <label class="settings-label">Theme</label>
            <select class="settings-select" id="theme-select">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="blue">Blue</option>
            </select>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
    <script src="https://dbghelp.github.io/M3U8Interpreter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        class EnhancedMobileIPTV {
            constructor() {
                this.channels = [];
                this.currentChannelIndex = 0;
                this.player = null;
                this.xmlepg = null;
                this.isFullscreen = false;
                this.favorites = JSON.parse(localStorage.getItem('iptv_favorites') || '[]');
                this.recentChannels = JSON.parse(localStorage.getItem('iptv_recent') || '[]');
                this.categories = {};
                this.currentCategory = 'all';

                this.initializeApp();
            }

            initializeApp() {
                this.initializePlayer();
                this.loadDefaultPlaylist();
                this.setupEventListeners();
                this.initDRMSettings();
                this.updateRecentChannelsUI();
            }

            initializePlayer() {
                this.player = new shaka.Player(document.getElementById('video'));
                shaka.polyfill.installAll();

                this.player.addEventListener('loading', () => {
                    document.getElementById('loading').style.display = 'block';
                    this.updateChannelStatus('Loading...');
                });

                this.player.addEventListener('loaded', () => {
                    document.getElementById('loading').style.display = 'none';
                    this.updateChannelStatus('Playing');
                    document.getElementById('video').play().catch(() => this.showToast('Tap video to play'));
                });

                this.player.addEventListener('error', (e) => {
                    document.getElementById('loading').style.display = 'none';
                    this.updateChannelStatus('Error');
                    this.showToast(`Error: ${e.detail?.code || 'Unknown'}`);
                });
            }

            async loadDefaultPlaylist() {
                const url = 'https://reiyhbit.github.io/iptv/playlist112525.m3u';
                try {
                    document.getElementById('loading').style.display = 'block';
                    const res = await fetch(url);
                    const text = await res.text();
                    this.parsePlaylist(text);
                } catch (e) {
                    this.showToast('Failed to load playlist');
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            parsePlaylist(content) {
                const parser = new M3U8Interpreter(content);
                parser.parse();
                this.channels = parser.getChannels();

                this.extractCategories();
                this.updateCategoryTabs();
                this.updateChannelList();
                this.updateQuickChannels();

                if (this.channels.length > 0) this.playChannel(0);
            }

            extractCategories() {
                this.categories = { all: this.channels, favorites: [] };
                this.channels.forEach(ch => {
                    if (ch.groupTitle && !this.categories[ch.groupTitle]) {
                        this.categories[ch.groupTitle] = this.channels.filter(c => c.groupTitle === ch.groupTitle);
                    }
                    if (this.favorites.includes(this.channels.indexOf(ch))) {
                        this.categories.favorites.push(ch);
                    }
                });
            }

            updateCategoryTabs() {
                const container = document.getElementById('category-tabs');
                Object.keys(this.categories).forEach(cat => {
                    if (cat === 'all' || cat === 'favorites') return;
                    const btn = document.createElement('button');
                    btn.className = 'category-tab';
                    btn.textContent = cat;
                    btn.dataset.category = cat;
                    btn.onclick = () => this.switchCategory(cat);
                    container.appendChild(btn);
                });
            }

            switchCategory(cat) {
                this.currentCategory = cat;
                document.querySelectorAll('.category-tab').forEach(t => t.classList.toggle('active', t.dataset.category === cat));
                this.updateQuickChannels();
            }

            playChannel(index) {
                if (index < 0 || index >= this.channels.length) return;
                this.currentChannelIndex = index;
                const ch = this.channels[index];

                this.addToRecent(index);

                // === DRM CONFIGURATION ===
                const drmType = localStorage.getItem('drm_type') || 'com.widevine.alpha';

                // Reset DRM first
                this.player.configure({ drm: { servers: {}, clearKeys: {} } });

                if (drmType === 'com.widevine.alpha') {
                    const url = localStorage.getItem('widevine_license_url');
                    if (url?.trim()) {
                        this.player.configure({ drm: { servers: { 'com.widevine.alpha': url.trim() } } });
                    }
                } else if (drmType === 'org.w3.clearkey') {
                    const kid = localStorage.getItem('clearkey_kid')?.trim();
                    const key = localStorage.getItem('clearkey_key')?.trim();
                    if (kid && key && kid.length === 32 && key.length === 32) {
                        this.player.configure({
                            drm: { clearKeys: { [kid.toLowerCase()]: key.toLowerCase() } }
                        });
                    } else if (kid || key) {
                        this.showToast('ClearKey must be 32 hex chars');
                    }
                }

                // Support playlist-embedded licenseKey (old method)
                if (ch.licenseKey) {
                    try {
                        const keys = JSON.parse(decodeURIComponent(ch.licenseKey));
                        const clearKeys = {};
                        keys.forEach(k => clearKeys[k.keyId] = k.key);
                        this.player.configure({ drm: { clearKeys } });
                    } catch (e) {}
                }
                // === END DRM ===

                this.player.load(ch.manifestUrl);
                this.updateChannelInfo(ch.channelName);
                this.updateFavoriteButton();
                this.updateQuickChannels();
                this.updateChannelList();
                this.showToast(`Playing: ${ch.channelName}`);
            }

            addToRecent(index) {
                this.recentChannels = this.recentChannels.filter(i => i !== index);
                this.recentChannels.unshift(index);
                if (this.recentChannels.length > 5) this.recentChannels.pop();
                localStorage.setItem('iptv_recent', JSON.stringify(this.recentChannels));
                this.updateRecentChannelsUI();
            }

            updateRecentChannelsUI() {
                const c = document.getElementById('recent-channels');
                if (!this.recentChannels.length) return c.style.display = 'none';
                c.style.display = 'block';
                c.innerHTML = '<span style="margin-right:10px;font-size:11px;color:#aaa">Recent:</span>';
                this.recentChannels.forEach(i => {
                    const ch = this.channels[i];
                    if (!ch) return;
                    const el = document.createElement('div');
                    el.className = 'recent-channel';
                    el.innerHTML = `<img src="${ch.tvgLogo}" style="width:14px;height:14px;border-radius:2px;margin-right:4px" onerror="this.style.display='none'"><span>${ch.channelName}</span>`;
                    el.onclick = () => this.playChannel(i);
                    c.appendChild(el);
                });
            }

            toggleFavorite() {
                const i = this.currentChannelIndex;
                if (this.favorites.includes(i)) {
                    this.favorites = this.favorites.filter(x => x !== i);
                    this.showToast('Removed from favorites');
                } else {
                    this.favorites.push(i);
                    this.showToast('Added to favorites');
                }
                localStorage.setItem('iptv_favorites', JSON.stringify(this.favorites));
                this.categories.favorites = this.channels.filter((_, idx) => this.favorites.includes(idx));
                this.updateFavoriteButton();
                this.updateQuickChannels();
            }

            updateFavoriteButton() {
                const btn = document.getElementById('favorite-btn');
                const active = this.favorites.includes(this.currentChannelIndex);
                btn.classList.toggle('active', active);
                btn.innerHTML = active ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            }

            updateChannelInfo(name) { document.getElementById('current-channel').textContent = name; }
            updateChannelStatus(s) { document.getElementById('channel-status').textContent = s; }

            nextChannel() {
                const list = this.categories[this.currentCategory] || this.channels;
                let idx = list.findIndex(c => this.channels.indexOf(c) === this.currentChannelIndex);
                this.playChannel(this.channels.indexOf(list[(idx + 1) % list.length]));
            }

            prevChannel() {
                const list = this.categories[this.currentCategory] || this.channels;
                let idx = list.findIndex(c => this.channels.indexOf(c) === this.currentChannelIndex);
                this.playChannel(this.channels.indexOf(list[(idx - 1 + list.length) % list.length]));
            }

            toggleFullscreen() {
                this.isFullscreen = !this.isFullscreen;
                document.getElementById('app-container').classList.toggle('fullscreen', this.isFullscreen);
                document.getElementById('maximize-btn').textContent = this.isFullscreen ? 'Exit Full Screen' : 'Full Screen';
            }

            showToast(msg) {
                const t = document.createElement('div');
                t.className = 'toast';
                t.textContent = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            initDRMSettings() {
                const typeSel = document.getElementById('licenseTypeSelect');
                const widevineDiv = document.getElementById('widevineUrlOption');
                const clearkeyDiv = document.getElementById('clearkeyOption');
                const urlInput = document.getElementById('widevineLicenseUrl');
                const kidInput = document.getElementById('clearkeyId');
                const keyInput = document.getElementById('clearkeyKey');

                // Load saved
                typeSel.value = localStorage.getItem('drm_type') || 'com.widevine.alpha';
                urlInput.value = localStorage.getItem('widevine_license_url') || '';
                kidInput.value = localStorage.getItem('clearkey_kid') || '';
                keyInput.value = localStorage.getItem('clearkey_key') || '';

                const toggle = () => {
                    if (typeSel.value === 'com.widevine.alpha') {
                        widevineDiv.style.display = 'block';
                        clearkeyDiv.style.display = 'none';
                    } else {
                        widevineDiv.style.display = 'none';
                        clearkeyDiv.style.display = 'block';
                    }
                };
                toggle();
                typeSel.onchange = () => {
                    localStorage.setItem('drm_type', typeSel.value);
                    toggle();
                };
                urlInput.onchange = () => localStorage.setItem('widevine_license_url', urlInput.value.trim());
                kidInput.onchange = () => localStorage.setItem('clearkey_kid', kidInput.value.trim());
                keyInput.onchange = () => localStorage.setItem('clearkey_key', keyInput.value.trim());
            }

            setupEventListeners() {
                document.getElementById('prev-channel').onclick = () => this.prevChannel();
                document.getElementById('next-channel').onclick = () => this.nextChannel();
                document.getElementById('channel-list-btn').onclick = () => document.getElementById('channel-overlay').style.display = 'flex';
                document.getElementById('close-channels').onclick = () => document.getElementById('channel-overlay').style.display = 'none';
                document.getElementById('maximize-btn').onclick = () => this.toggleFullscreen();
                document.getElementById('favorite-btn').onclick = () => this.toggleFavorite();
                document.getElementById('settings-btn').onclick = () => document.getElementById('settings-panel').classList.add('open');
                document.getElementById('close-settings').onclick = () => document.getElementById('settings-panel').classList.remove('open');
                document.getElementById('volume-slider').oninput = e => document.getElementById('video').volume = e.target.value / 100;
                document.getElementById('channel-search').oninput = e => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('.channel-item').forEach(item => {
                        item.style.display = item.querySelector('.channel-name').textContent.toLowerCase().includes(term) ? 'flex' : 'none';
                    });
                };
            }

            updateQuickChannels() {
                const container = document.getElementById('quick-channels');
                container.innerHTML = '';
                const list = this.categories[this.currentCategory] || this.channels;
                if (!list.length) {
                    container.innerHTML = `<div style="grid-column:1/3;text-align:center;padding:20px;color:#888">No channels</div>`;
                    return;
                }
                list.forEach(ch => {
                    const idx = this.channels.indexOf(ch);
                    const div = document.createElement('div');
                    div.className = 'quick-channel' + (idx === this.currentChannelIndex ? ' active' : '');
                    div.innerHTML = `
                        <img src="${ch.tvgLogo}" class="channel-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaW...">
                        <span class="channel-name">${ch.channelName}</span>
                        ${this.favorites.includes(idx) ? '<span class="channel-fav">★</span>' : ''}
                    `;
                    div.onclick = () => this.playChannel(idx);
                    container.appendChild(div);
                });
            }

            updateChannelList() {
                const list = document.getElementById('channels-list');
                list.innerHTML = '';
                this.channels.forEach((ch, i) => {
                    const item = document.createElement('div');
                    item.className = 'channel-item' + (i === this.currentChannelIndex ? ' active' : '');
                    item.innerHTML = `
                        <img src="${ch.tvgLogo}" class="channel-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaW...">
                        <span class="channel-name">${ch.channelName}</span>
                        ${this.favorites.includes(i) ? '<span class="channel-fav">★</span>' : ''}
                    `;
                    item.onclick = () => {
                        this.playChannel(i);
                        document.getElementById('channel-overlay').style.display = 'none';
                    };
                    list.appendChild(item);
                });
            }

            showToast = msg => {
                const t = document.createElement('div');
                t.className = 'toast';
                t.textContent = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            };
        }

        let app;
        document.addEventListener('DOMContentLoaded', () => app = new EnhancedMobileIPTV());
    </script>
</body>
</html>
