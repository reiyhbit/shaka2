<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ReiStream TV v2</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://unpkg.com/mux.js@latest/dist/mux.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.min.css">
  <style>
    :root{--bg:#0a0a0a;--card:#111;--accent:#00d4ff;--text:#fff;--muted:#aaa;--border:#222;--hover:#1a1a1a}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
    header{background:rgba(17,17,17,0.95);backdrop-filter:blur(10px);padding:1rem;text-align:center;border-bottom:1px solid var(--border)}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,#00d4ff,#00ff9d);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    main{flex:1;display:grid;grid-template-columns:1fr 380px;gap:0;height:calc(100vh - 72px)}
    @media(max-width:992px){main{grid-template-columns:1fr}.sidebar{display:none}.mobile-btn{display:flex!important}}
    #video-container{position:relative;background:#000}
    #video{width:100%;height:100%;object-fit:contain}
    .channel-name{position:absolute;bottom:20px;left:20px;background:rgba(0,0,0,0.7);padding:8px 16px;border-radius:8px;font-weight:600;backdrop-filter:blur(10px);z-index:5}
    .loading{position:absolute;inset:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;gap:1rem;font-size:1.1rem}
    .spinner{width:50px;height:50px;border:4px solid #222;border-top:4px solid var(--accent);border-radius:50%;animation:s 1s linear infinite}
    @keyframes s{to{transform:rotate(360deg)}}
    .sidebar{background:var(--card);border-left:1px solid var(--border);overflow-y:auto;padding:1rem}
    .search-box{width:100%;padding:12px 16px;background:var(--hover);border:1px solid var(--border);border-radius:12px;color:white;margin-bottom:1rem}
    .channel-item{padding:12px 16px;border-radius:10px;margin-bottom:6px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:12px}
    .channel-item:hover{background:var(--hover)}
    .channel-item.active{background:var(--accent);color:#000;font-weight:600}
    .channel-logo{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#222}
    .mobile-btn{display:none;position:absolute;top:80px;right:16px;background:rgba(0,0,0,0.7);color:white;border:none;padding:12px;border-radius:50%;z-index:10;backdrop-filter:blur(10px)}
    .status{font-size:0.8rem;color:var(--muted);text-align:center;margin-top:10px}
    .footer{text-align:center;padding:0.5rem;font-size:0.8rem;color:var(--muted);background:var(--card);border-top:1px solid var(--border)}
  </style>
</head>
<body>
  <header><div class="logo">ReiStream TV v2</div></header>
  <button class="mobile-btn" onclick="document.querySelector('.sidebar').style.display='block'">List</button>

  <main>
    <div id="video-container">
      <video id="video" playsinline autoplay muted></video>
      <div class="channel-name" id="current-channel">Loading playlist...</div>
      <div class="loading" id="loading"><div class="spinner"></div><div>Loading channels...</div></div>
    </div>

    <aside class="sidebar">
      <input type="text" class="search-box" placeholder="Search channels..." id="search">
      <div class="status" id="status">Loading...</div>
      <ul class="channel-list" id="channels"></ul>
    </aside>
  </main>

  <div class="footer">© 2025 ReiStream • Updated Nov 28, 2025</div>

  <script>
    const video = document.getElementById('video');
    const container = document.getElementById('video-container');
    const nameEl = document.getElementById('current-channel');
    const loading = document.getElementById('loading');
    const listEl = document.getElementById('channels');
    const statusEl = document.getElementById('status');
    const search = document.getElementById('search');

    let player, channels = [], working = 0;

    // PLAYLIST MO (direct load)
    const PLAYLIST = "https://reiyhbit.github.io/iptv/playlist112525.m3u";

    function initPlayer() {
      shaka.polyfill.installAll();
      player = new shaka.Player(video);
      new shaka.ui.Overlay(player, container, video);
      player.addEventListener('error', e => {
        nameEl.textContent = "Stream failed – trying next...";
        console.warn("Error:", e.detail);
        autoNextChannel(); // magic na gagawin
      });
    }

    async function loadPlaylist() {
      try {
        const r = await fetch(PLAYLIST + "?t=" + Date.now()); // bypass cache
        const text = await r.text();
        channels = parseM3U(text).filter(c => c.url.includes('.m3u8') || c.url.includes('http'));
        statusEl.textContent = `Loaded ${channels.length} channels • Testing live ones...`;
        renderChannels();
        testAndPlayFirstWorking(); // ito ang bagong magic
      } catch { nameEl.textContent = "Playlist unreachable"; }
    }

    function parseM3U(t) {
      const lines = t.split('\n');
      const res = [];
      let ch = {};
      for (let l of lines) {
        l = l.trim();
        if (l.startsWith('#EXTINF:')) {
          const name = l.split(',').pop().trim();
          const logo = l.match(/tvg-logo="([^"]+)"/)?.[1] || '';
          ch = { name, logo };
        } else if (l && !l.startsWith('#')) {
          ch.url = l;
          if (ch.name && ch.url) res.push(ch);
          ch = {};
        }
      }
      return res.sort((a,b) => a.name.localeCompare(b.name));
    }

    function renderChannels() {
      listEl.innerHTML = "";
      channels.forEach((c, i) => {
        const li = document.createElement('li');
        li.className = "channel-item";
        li.innerHTML = `<img src="${c.logo||'https://via.placeholder.com/36/222/fff?text=TV'}" class="channel-logo" onerror="this.src='https://via.placeholder.com/36/222/fff?text=TV'">
                        <div class="channel-title">${c.name}</div>`;
        li.onclick = () => play(i);
        listEl.appendChild(li);
      });
    }

    async function testAndPlayFirstWorking() {
      loading.style.display = "flex";
      for (let i = 0; i < channels.length; i++) {
        if (await isLive(channels[i].url)) {
          play(i);
          working++;
          statusEl.textContent = `${working} working channels found so far`;
          return;
        }
      }
      nameEl.textContent = "No working streams right now";
      loading.style.display = "none";
    }

    async function isLive(url) {
      try {
        const r = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
        return true;
      } catch {
        try {
          const r = await fetch(url.split('|')[0] + "?test=1", { signal: AbortSignal.timeout(7000) });
          return r.ok;
        } catch { return false; }
      }
    }

    async function play(idx) {
      const ch = channels[idx];
      document.querySelectorAll('.channel-item').forEach((el,i)=>el.classList.toggle('active', i===idx));
      nameEl.textContent = ch.name;
      loading.style.display = "flex";
      try {
        await player.load(ch.url);
        loading.style.display = "none";
      } catch {
        loading.style.display = "none";
        nameEl.textContent = "Failed – trying next...";
        autoNextChannel();
      }
    }

    function autoNextChannel() {
      let idx = channels.findIndex(c => c.name === nameEl.textContent);
      idx = (idx + 1) % channels.length;
      setTimeout(() => play(idx), 2000);
    }

    search.addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const filtered = channels.filter(c => c.name.toLowerCase().includes(term));
      listEl.innerHTML = "";
      filtered.forEach((c,i) => {
        const li = document.createElement('li');
        li.className = "channel-item";
        li.innerHTML = `<img src="${c.logo||'https://via.placeholder.com/36/222/fff?text=TV'}" class="channel-logo">
                        <div class="channel-title">${c.name}</div>`;
        li.onclick = () => play(channels.indexOf(c));
        listEl.appendChild(li);
      });
    });

    window.onload = () => {
      initPlayer();
      loadPlaylist();
    };
  </script>
</body>
</html>
